---
title: "Apra Data Science Challenge 2025"
output: html_notebook
---

# Load Libraries
```{r}

packages <- c(
  'ggplot2','tidyverse','plotly','leaflet',
  'shiny','shinyWidgets','shinydashboard',
  'xts','forecast','TTR','treemapify',
  'DT','lubridate','RColorBrewer','scales','stopwords',
  'tidytext','stringr','wordcloud','wordcloud2','scales','dplyr','rfm',
  'SnowballC','textmineR','topicmodels','textclean','tm'
)
for (package in packages) { 
  if (!require(package, character.only = T, quietly = T)) {
    install.packages(package)
    library(package, character.only = T)
  }
}
```

# Load data
```{r}
crm <- read_csv("CRM_interacions_table.csv")
gift <- read_csv("gift_transactions_table.csv")
video <- read_csv("video_email_data_table.csv")
constituent <- read_csv("constituent_profiles_table.csv")
```

# Part 1: The Untapped Potential: Understanding Our Donor Landscape

## CRM Data Overview
```{r}
# CRM Interaction Type
g <- crm %>%
        group_by(CRM_INTERACTION_TYPE) %>%
        summarise(Total = n()) %>%
        select(CRM_INTERACTION_TYPE, Total) %>%
        ggplot(aes(x = reorder(CRM_INTERACTION_TYPE,Total) ,y = Total))  +
        geom_bar(stat = "identity",width = 0.5, fill='black')  +
        scale_y_continuous(labels = scales::comma) +
        labs(x ="CRM Interaction Type", y = "Count") + coord_flip() +
        theme(legend.text = element_text(size = 12),
              legend.title = element_text(size = 12),
              axis.title = element_text(size = 14),
              axis.text = element_text(size = 12))
      
ggplotly(g)
```


### CRM Interaction Over Time
```{r}
crm <- crm %>%
        mutate(Year = lubridate::year(CRM_INTERACTION_DATE),
               Quarter = lubridate::quarter(CRM_INTERACTION_DATE),
               Month = lubridate::month(CRM_INTERACTION_DATE, label = TRUE),
               DOW = lubridate::wday(CRM_INTERACTION_DATE, label=TRUE))
```

### CRM Interaction by Year
```{r}
crm_year <- crm %>%
group_by(Year, CRM_INTERACTION_TYPE) %>%
        summarise(Total = n()) %>%
        select(Year,CRM_INTERACTION_TYPE, Total)

   g <- ggplot(crm_year, aes(as.factor(Year), Total, group=CRM_INTERACTION_TYPE, colour = CRM_INTERACTION_TYPE)) + 
      geom_line( linewidth=1) + theme_minimal() +
      labs(x = "Year", y = "Total", color="CRM Interaction Type") + 
      scale_y_continuous(labels = comma) +
      theme(legend.text = element_text(size = 10),
            legend.title = element_text(size = 10),
            axis.title = element_text(size = 10),
            axis.text = element_text(size = 10),
            axis.text.x = element_text(angle = 0, hjust = 1))
ggplotly(g)
```

### CRM Interaction by Quarter
```{r}
crm %>%
group_by(Quarter, CRM_INTERACTION_TYPE) %>%
        summarise(Total = n()) %>%
        select(Quarter,CRM_INTERACTION_TYPE, Total) %>% 
      ggplot(aes(as.factor(Quarter), Total, group=CRM_INTERACTION_TYPE, colour = CRM_INTERACTION_TYPE)) + 
      geom_line( linewidth=1) + theme_minimal() +
      labs(x = "Quarter", y = "Total", color="CRM Interaction Type") + 
      scale_y_continuous(labels = comma) +
      theme(legend.text = element_text(size = 10),
            legend.title = element_text(size = 10),
            axis.title = element_text(size = 10),
            axis.text = element_text(size = 10),
            axis.text.x = element_text(angle = 0, hjust = 1))

```

### CRM Interaction by Month
```{r}
crm %>%
group_by(Month, CRM_INTERACTION_TYPE) %>%
        summarise(Total = n()) %>%
        select(Month,CRM_INTERACTION_TYPE, Total) %>% 
      ggplot(aes(as.factor(Month), Total, group=CRM_INTERACTION_TYPE, colour = CRM_INTERACTION_TYPE)) + 
      geom_line( linewidth=1) + theme_minimal() +
      labs(x = "Month", y = "Total", color="CRM Interaction Type") + 
      scale_y_continuous(labels = comma) +
      theme(legend.text = element_text(size = 10),
            legend.title = element_text(size = 10),
            axis.title = element_text(size = 10),
            axis.text = element_text(size = 10),
            axis.text.x = element_text(angle = 0, hjust = 1))
```


### CRM Interaction by Day of Week
```{r}
crm %>%
group_by(DOW, CRM_INTERACTION_TYPE) %>%
        summarise(Total = n()) %>%
        select(DOW,CRM_INTERACTION_TYPE, Total) %>% 
      ggplot(aes(as.factor(DOW), Total, group=CRM_INTERACTION_TYPE, colour = CRM_INTERACTION_TYPE)) + 
      geom_line( linewidth=1) + theme_minimal() +
      labs(x = "Day of Week", y = "Total", color="CRM Interaction Type") + 
      scale_y_continuous(labels = comma) +
      theme(legend.text = element_text(size = 10),
            legend.title = element_text(size = 10),
            axis.title = element_text(size = 10),
            axis.text = element_text(size = 10),
            axis.text.x = element_text(angle = 0, hjust = 1))
```
## Gift Overview

### Gifts by CRM Interaction Type
```{r}
left_join(gift,crm,by='CONSTITUENT_ID') %>%
  group_by(CRM_INTERACTION_TYPE) %>%
  summarise(Total = sum(AMOUNT)) %>%
  select(CRM_INTERACTION_TYPE,Total) %>%
  ggplot(aes(x = reorder(CRM_INTERACTION_TYPE,Total) ,y = Total))  +
        geom_bar(stat = "identity",width = 0.5, fill='black')  +
        scale_y_continuous(labels = scales::comma) +
        labs(x ="CRM Interaction Type", y = "Donations") + coord_flip() +
        theme(legend.text = element_text(size = 12),
              legend.title = element_text(size = 12),
              axis.title = element_text(size = 14),
              axis.text = element_text(size = 12))


```

### Gifts overtime
```{r}
gift <- gift %>%
        mutate(Year = lubridate::year(GIFT_DATE),
               Quarter = lubridate::quarter(GIFT_DATE),
               Month = lubridate::month(GIFT_DATE, label = TRUE),
               DOW = lubridate::wday(GIFT_DATE, label=TRUE))
```

### Gift by Year
```{r}
g <- gift %>%
group_by(Year) %>%
        summarise(Total = sum(AMOUNT)) %>%
        select(Year, Total) %>% 
        na.omit() %>%
      ggplot(aes(Year, Total)) + 
      geom_bar(stat = "identity",width = 0.5, fill='black') + theme_minimal() +
      labs(x = "Year", y = "Total") + 
      scale_y_continuous(labels = comma) +
      theme(legend.text = element_text(size = 10),
            legend.title = element_text(size = 10),
            axis.title = element_text(size = 10),
            axis.text = element_text(size = 10),
            axis.text.x = element_text(angle = 90, hjust = 1))
ggplotly(g)
```

### Gift by Quarter
```{r}
g <- gift %>%
group_by(Quarter) %>%
        summarise(Total = sum(AMOUNT)) %>%
        select(Quarter, Total) %>% 
        na.omit() %>%
      ggplot(aes(Quarter, Total)) + 
      geom_bar(stat = "identity",width = 0.5, fill='black') + theme_minimal() +
      labs(x = "Quarter", y = "Total") + 
      scale_y_continuous(labels = comma) +
      theme(legend.text = element_text(size = 10),
            legend.title = element_text(size = 10),
            axis.title = element_text(size = 10),
            axis.text = element_text(size = 10),
            axis.text.x = element_text(angle = 0, hjust = 1))
ggplotly(g)
```

### Gift by Month
```{r}
g <- gift %>%
group_by(Month) %>%
        summarise(Total = sum(AMOUNT)) %>%
        select(Month, Total) %>% 
        na.omit() %>%
      ggplot(aes(Month, Total)) + 
      geom_bar(stat = "identity",width = 0.5, fill='black') + theme_minimal() +
      labs(x = "Month", y = "Total") + 
      scale_y_continuous(labels = comma) +
      theme(legend.text = element_text(size = 10),
            legend.title = element_text(size = 10),
            axis.title = element_text(size = 10),
            axis.text = element_text(size = 10),
            axis.text.x = element_text(angle = 0, hjust = 1))
ggplotly(g)
```

Gift by Day of Week
```{r}
g <- gift %>%
group_by(DOW) %>%
        summarise(Total = sum(AMOUNT)) %>%
        select(DOW, Total) %>% 
        na.omit() %>%
      ggplot(aes(DOW, Total)) + 
      geom_bar(stat = "identity",width = 0.5, fill='black') + theme_minimal() +
      labs(x = "Day of Week", y = "Total") + 
      scale_y_continuous(labels = comma) +
      theme(legend.text = element_text(size = 10),
            legend.title = element_text(size = 10),
            axis.title = element_text(size = 10),
            axis.text = element_text(size = 10),
            axis.text.x = element_text(angle = 0, hjust = 1))
ggplotly(g)
```

## Video Overview
### Video Views over time
```{r}
video <- video %>%
        mutate(Year = lubridate::year(SENT_DATE),
               Quarter = lubridate::quarter(SENT_DATE),
               Month = lubridate::month(SENT_DATE, label = TRUE),
               DOW = lubridate::wday(SENT_DATE, label=TRUE))
```

### Video views by year
```{r}
g <- video %>%
group_by(Year) %>%
        summarise(Total = sum(VIDEO_VIEWS)) %>%
        select(Year, Total) %>% 
        na.omit() %>%
      ggplot(aes(as.factor(Year), Total)) + 
      geom_bar(stat = "identity",width = 0.5, fill='black') + theme_minimal() +
      labs(x = "Year", y = "Total") + 
      scale_y_continuous(labels = comma) +
      theme(legend.text = element_text(size = 10),
            legend.title = element_text(size = 10),
            axis.title = element_text(size = 10),
            axis.text = element_text(size = 10),
            axis.text.x = element_text(angle = 0, hjust = 1))
ggplotly(g)
```

### Video Views by Quarter
```{r}
g <- video %>%
group_by(Quarter) %>%
        summarise(Total = sum(VIDEO_VIEWS)) %>%
        select(Quarter, Total) %>% 
        na.omit() %>%
      ggplot(aes(Quarter, Total)) + 
      geom_bar(stat = "identity",width = 0.5, fill='black') + theme_minimal() +
      labs(x = "Quarter", y = "Total") + 
      scale_y_continuous(labels = comma) +
      theme(legend.text = element_text(size = 10),
            legend.title = element_text(size = 10),
            axis.title = element_text(size = 10),
            axis.text = element_text(size = 10),
            axis.text.x = element_text(angle = 0, hjust = 1))
ggplotly(g)
```

### Video Views by Month
```{r}
g <- video %>%
group_by(Month) %>%
        summarise(Total = sum(VIDEO_VIEWS)) %>%
        select(Month, Total) %>% 
        na.omit() %>%
      ggplot(aes(Month, Total)) + 
      geom_bar(stat = "identity",width = 0.5, fill='black') + theme_minimal() +
      labs(x = "Month", y = "Total") + 
      scale_y_continuous(labels = comma) +
      theme(legend.text = element_text(size = 10),
            legend.title = element_text(size = 10),
            axis.title = element_text(size = 10),
            axis.text = element_text(size = 10),
            axis.text.x = element_text(angle = 0, hjust = 1))
ggplotly(g)
```

### Video Views by Day of Week
```{r}
g <- video %>%
group_by(DOW) %>%
        summarise(Total = sum(VIDEO_VIEWS)) %>%
        select(DOW, Total) %>% 
        na.omit() %>%
      ggplot(aes(DOW, Total)) + 
      geom_bar(stat = "identity",width = 0.5, fill='black') + theme_minimal() +
      labs(x = "Day of the week", y = "Total") + 
      scale_y_continuous(labels = comma) +
      theme(legend.text = element_text(size = 10),
            legend.title = element_text(size = 10),
            axis.title = element_text(size = 10),
            axis.text = element_text(size = 10),
            axis.text.x = element_text(angle = 0, hjust = 1))
ggplotly(g)
```

# Part 2: Donations Portfolio
## Donor RFM Analysis
```{r}

rfm_df <- gift %>%
  filter(GIFT_DATE >= '2015-01-01') %>%
  select(CONSTITUENT_ID,GIFT_DATE,AMOUNT) %>%
  na.omit()

names(rfm_df)[names(rfm_df) == 'CONSTITUENT_ID'] <- 'customer_id'

#rfm model setup
analysis_date <- lubridate::as_date(today(), tz = "UTC")

report <- rfm_table_order(rfm_df, customer_id,GIFT_DATE,AMOUNT, analysis_date)
#segment
segment_titles <- c("First Grade", "Loyal", "Likely to be Loyal",
                    "New Ones", "Could be Promising", "Require Assistance", "Getting Less Frequent",
                    "Almost Out", "Can't Lose Them", "Donâ€™t Show Up at All")
#numerical thresholds
 r_low <- c(4, 2, 3, 4, 3, 2, 2, 1, 1, 1)
 r_high <- c(5, 5, 5, 5, 4, 3, 3, 2, 1, 2)
 f_low <- c(4, 3, 1, 1, 1, 2, 1, 2, 4, 1)
 f_high <- c(5, 5, 3, 1, 1, 3, 2, 5, 5, 2)
 m_low <- c(4, 3, 1, 1, 1, 2, 1, 2, 4, 1)
 m_high  <- c(5, 5, 3, 1, 1, 3, 2, 5, 5, 2)

divisions<-rfm_segment(report, segment_titles, r_low, r_high, f_low, f_high, m_low, m_high)

#names(divisions)[names(divisions) == 'customer_id'] <- 'CONSTITUENT_ID'

division_count <- divisions %>% count(segment) %>% arrange(desc(n)) %>% rename(Segment = segment, Count = n)
```

### RFM Metrics
```{r}
### rfm metrics - monetary
divisions %>%
group_by(segment) %>%
  summarise(Total = mean(amount)) %>%
  select(segment,Total) %>%
  ggplot(aes(x = reorder(segment,Total) ,y = Total))  +
        geom_bar(stat = "identity",width = 0.5, fill='black')  +
        scale_y_continuous(labels = scales::comma) +
        labs(x ="Segment", y = "Avg. Monetary") + coord_flip() +
        theme(legend.text = element_text(size = 12),
              legend.title = element_text(size = 12),
              axis.title = element_text(size = 14),
              axis.text = element_text(size = 12))

```

```{r}
### rfm metrics - frequency
division_count %>%
group_by(Segment) %>%
  summarise(Total = mean(Count)) %>%
  select(Segment,Total) %>%
  ggplot(aes(x = reorder(Segment,Total) ,y = Total))  +
        geom_bar(stat = "identity",width = 0.5, fill='black')  +
        scale_y_continuous(labels = scales::comma) +
        labs(x ="Segment", y = "Avg. Frequency") + coord_flip() +
        theme(legend.text = element_text(size = 12),
              legend.title = element_text(size = 12),
              axis.title = element_text(size = 14),
              axis.text = element_text(size = 12))

```

```{r}
### rfm metrics - recency
divisions %>%
group_by(segment) %>%
  summarise(Total = mean(recency_days)) %>%
  select(segment,Total) %>%
  ggplot(aes(x = reorder(segment,Total) ,y = Total))  +
        geom_bar(stat = "identity",width = 0.5, fill='black')  +
        scale_y_continuous(labels = scales::comma) +
        labs(x ="Segment", y = "Avg. Recency") + coord_flip() +
        theme(legend.text = element_text(size = 12),
              legend.title = element_text(size = 12),
              axis.title = element_text(size = 14),
              axis.text = element_text(size = 12))
```

```{r}
## constituent ouput
### segment
### transaction, recency, monntary
```


### Donor Segmentation
```{r}
`Portfolios` <- c(unique(division_count$Segment))
ggplot(division_count, aes(area = Count, fill = `Portfolios`, label = `Segment`) ) +
  geom_treemap(stat = "identity",
  position = "identity") +
  geom_treemap_text(place = "centre",size = 12)
```

### Donor Lifetime Value
```{r}
# Calculate average donation per customer
avg_donation_per_customer <- gift %>%
  filter((GIFT_DATE >= '2015-01-01') & (GIFT_DATE < analysis_date)) %>%
  group_by(CONSTITUENT_ID) %>%
  summarize(avg_revenue = mean(AMOUNT))

# Calculate average donor lifespan (simplified, using the number of months)
avg_donor_lifespan <- gift %>%
  group_by(CONSTITUENT_ID) %>% 
  summarize(avg_lifespan = as.numeric(difftime(max(GIFT_DATE), min(GIFT_DATE), units = "days"))) %>%
  na.omit()

# Calculate CLV
clv_df <- inner_join(avg_donation_per_customer,avg_donor_lifespan,by='CONSTITUENT_ID') %>%
group_by(CONSTITUENT_ID) %>%
  mutate(CLV_calc = avg_revenue * avg_lifespan) %>%
  select(CONSTITUENT_ID,CLV_calc)


```


## Part 3: Donation Prediction

### Donor Forecasting
```{r}
# Forecast info
aggregate_info <- c("daily",'weekly','monthly')
horizon_info <- c(1:50) #default 14
frequency_info <- c(7, 12, 52, 365)
difference_info <- c("Yes","No")
log_info <- c("Yes","No")
model_info <- c('auto-arima','auto-exponential','simple-exponential',
                'double-exponential','triple-exponential', 'tbat','manual-arima')
note_info <- "Using only data from 2015 onwards"
forecast_info <- "Series: forecast data"
gift_train_df <- as.data.frame(tibble())
gift_test_df <- as.data.frame(tibble())
```
```{r}
# generating range of dates 
start_date <- as.Date("2015-01-01") 
end_date <- as.Date(today()) 
date_range <- data.frame(seq(start_date, end_date,"days")) 
gift_data <- data.frame(data=c(1:nrow(date_range)))
colnames(date_range) <- "GIFT_DATE"
date_range <- cbind(date_range,gift_data)
```
```{r}
# Generate gift date
transaction_f1 <- gift %>%
  filter(GIFT_DATE >= '2015-01-01',GIFT_DATE <= today()) %>%
  group_by(GIFT_DATE) %>%
  summarise(Total = sum(AMOUNT)) %>%
  right_join(date_range,by='GIFT_DATE', copy = TRUE) %>%
  replace(is.na(.), 0) %>%
  select(GIFT_DATE,Total)


```

```{r}
transaction_f <- transaction_f1 %>%
  right_join(date_range,by='GIFT_DATE', copy = TRUE) %>%
  replace(is.na(.), 0) %>%
  select(GIFT_DATE,Total)
```


```{r}
gift_xts <- xts(x = transaction_f$Total, order.by = transaction_f$GIFT_DATE) 
gift_daily <- apply.daily(gift_xts,colMeans)
gift_weekly <- apply.weekly(gift_xts, colMeans) 
gift_monthly <- apply.monthly(gift_xts, colMeans) 
```
```{r}
forecast_df <- function (ts_df,aggregateInput,frequencyInput,dataType) {
  if(aggregateInput == 'daily'){
    gift_data <- apply.daily(ts_df,mean)
    gift_end <- floor(0.8*length(gift_data)) 
    gift_train <- gift_data[1:gift_end,] 
    gift_test <- gift_data[(gift_end+1):length(gift_data),]
    gift_start <- c(year (start(gift_train)), month(start(gift_train)),
                    day(start(gift_train)))
    gift_end <- c(year(end(gift_train)), month(end(gift_train)), 
                  day(end(gift_train)))
    gift_train <- ts(as.numeric(gift_train), start = gift_start, 
                     end = gift_end, frequency = as.numeric(frequencyInput) )
    gift_start <- c(year (start(gift_test)), month(start(gift_test)),
                    day(start(gift_test)))
    gift_end <- c(year(end(gift_test)), month(end(gift_test)), 
                  day(end(gift_test)))
    gift_test <- ts(as.numeric(gift_test), start = gift_start, 
                    end = gift_end, frequency = as.numeric(frequencyInput))
  } else if(aggregateInput == 'weekly'){
    gift_data <- apply.weekly(ts_df, mean) 
    gift_end <- floor(0.8*length(gift_data)) 
    gift_train <- gift_data[1:gift_end,] 
    gift_test <- gift_data[(gift_end+1):length(gift_data),]
    gift_start <- c(year (start(gift_train)), month(start(gift_train)),
                    week(start(gift_train)))
    gift_end <- c(year(end(gift_train)), month(end(gift_train)), 
                  week(end(gift_train)))
    gift_train <- ts(as.numeric(gift_train), start = gift_start, 
                     end = gift_end, frequency = as.numeric(frequencyInput) )
    gift_start <- c(year (start(gift_test)), month(start(gift_test)),
                    week(start(gift_test)))
    gift_end <- c(year(end(gift_test)), month(end(gift_test)), 
                  week(end(gift_test)))
    gift_test <- ts(as.numeric(gift_test), start = gift_start, 
                    end = gift_end, frequency = as.numeric(frequencyInput))
  } else {
    gift_data <- apply.monthly(ts_df, mean) 
    gift_end <- floor(0.8*length(gift_data)) 
    gift_train <- gift_data[1:gift_end,] 
    gift_test <- gift_data[(gift_end+1):length(gift_data),]
    gift_start <- c(year (start(gift_train)), month(start(gift_train)))
    gift_end <- c(year(end(gift_train)), month(end(gift_train)))
    gift_train <- ts(as.numeric(gift_train), start = gift_start, 
                     end = gift_end, frequency = as.numeric(frequencyInput) )
    gift_start <- c(year (start(gift_test)), month(start(gift_test)))
    gift_end <- c(year(end(gift_test)), month(end(gift_test)))
    gift_test <- ts(as.numeric(gift_test), start = gift_start, 
                    end = gift_end, frequency = as.numeric(frequencyInput))
  }
  
  if (dataType == "train") {
    output <- gift_train
  } else {
    output <- gift_test
  }
  output
  
}
```

```{r}
numeric_update <- function(df){
  rownames(df) <- c()
  is.num <- sapply(df, is.numeric)
  df[is.num] <- lapply(df[is.num], round, 0)           
  return (df)
}
```


```{r}
  g <- autoplot(gift_daily) +   
        scale_y_continuous(labels = scales::comma) + labs(x ="Gift Date", y = "Gift Amount",
                                                          title = "Daily Gift Chart") + 
        theme(plot.title = element_text(hjust=0.5))
      ggplotly(g)
```

```{r}
    gift_weekly <- apply.weekly(gift_xts, mean) 
      g <- autoplot(gift_weekly) +   
        scale_y_continuous(labels = scales::comma) + labs(x ="Gift Date", y = "Gift Amount",
                                                          title = "Weekly Gift Chart") +
        theme(plot.title = element_text(hjust=0.5))
      ggplotly(g)
```

```{r}
      gift_monthly <- apply.monthly(gift_xts, mean)
      g <- autoplot(gift_monthly) +   
        scale_y_continuous(labels = scales::comma) + labs(x ="Gift Date", y = "Gift Amount",
                                                          title = "Monthly Gift Chart") + 
        theme(plot.title = element_text(hjust=0.5))
      ggplotly(g)
```


```{r}
```

```{r}

```


```{r}
```


```{r}
```

### Donor Prediction --> Next Best Donation
```{r}

```


