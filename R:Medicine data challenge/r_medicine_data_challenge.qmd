---
title: "Measles Vaccinations and Outbreak Trends"
date: "2025-05-05"
format:
  html:
    toc: true
    toc-depth: 3
    theme: cosmo
    code-fold: true
    code-tools: true
editor: visual
---

```{r setup libraries, include=FALSE}
# Ensure these are installed: install.packages(c("plotly", "dplyr", "readr", "lubridate", "tidyr", "janitor", "scales", "DT"))
packages <- c("plotly", "dplyr", "readr", "lubridate", "tidyr", "janitor", "scales", "DT")
for (package in packages) {
  if (!require(package, character.only=T, quietly=T)) {
    install.packages(package)
    library(package, character.only=T)
  }
}
```

```{r load data}
load_data <- function(url) {
  tryCatch(
    {
      df <- read_csv(url, show_col_types = FALSE) %>%
        janitor::clean_names() # Standardize column names
      message("Successfully loaded and cleaned data from: ", basename(url))
      return(df)
    },
    error = function(e) {
      message("Failed to load data from: ", url)
      message("Error: ", e$message)
      return(NULL)
    }
  )
}

# --- Data URLs ---
base_url <- "https://raw.githubusercontent.com/fbranda/measles/main/"
urls <- list(
  global_coverage = paste0(base_url, "Measles_vaccination_coverage_Global.csv"),
  global_cases = paste0(base_url, "Measles_Global.csv"),
  europe_cases = paste0(base_url, "Measles_Europe.csv"),
  us_coverage_cases = paste0(base_url, "USA/data/all/measles-USA-by-mmr-coverage.csv"),
  us_onset = paste0(base_url, "USA/data/all/measles-USA-by-onset-date.csv"),
  us_year = paste0(base_url, "USA/data/all/measles-USA-by-year.csv"),
  us_age_2025 = paste0(base_url, "USA/data/2025/measles-USA-by-age.csv"),
  us_county_2025 = paste0(base_url, "USA/data/2025/measles-USA-by-county-timeline.csv"),
  us_state_2025 = paste0(base_url, "USA/data/2025/measles-USA-by-state-timeline.csv"),
  us_confirmed_2025 = paste0(base_url, "USA/data/2025/measles-USA-confirmed-cases.csv")
)

#----Load Data----
data <- lapply(urls, load_data)

```

# Introduction

Changing attitudes towards vaccination have led to declining MMR coverage, putting herd immunity at risk. This document explores trends in vaccination, outbreaks using data from the 2025 R/Medicine Challenge.

# Data Exploration

## 1. Global Measles Vaccination Coverage

```{r global-measles-vaccination-coverage-plot}
if (!is.null(data$global_coverage)) {
  
  if (all(c("region", "year", "antigen") %in% names(data$global_coverage))) {
    coverage_summary <- data$global_coverage %>%
      filter(!is.na(antigen) & !is.na(region)) %>%
      group_by(region, year) %>%
      summarise(avg_coverage = mean(coverage, na.rm = TRUE), .groups = 'drop')
    
    p1_1 <- plot_ly(coverage_summary, x = ~year, y = ~avg_coverage, color = ~region,
                    type = 'scatter', mode = 'lines+markers',
                    text = ~paste("Region:", region, "<br>Year:", year, "<br>Coverage:", round(avg_coverage, 1), "%"),
                    hoverinfo = 'text') %>%
      layout(title = "Avg Coverage by WHO Region", yaxis = list(range = c(0,100), title="Avg Coverage (%)"))
    print(p1_1)
  } else { message("Required columns (region, year, antigen) not found in global_coverage.")}
  
}
```

---

---

---

---

```{r global-coverage-plot}
global_plot <- global_coverage %>%
  filter(year >= 2000) %>%
  plot_ly(x = ~year, y = ~coverage, color = ~country,
          type = 'scatter', mode = 'lines') %>%
  layout(title = "Global MMR 1st Dose Coverage Over Time",
         xaxis = list(title = "Year"),
         yaxis = list(title = "% Coverage"))
global_plot
```

```{r load-us-coverage}
us_coverage <- read_csv("https://raw.githubusercontent.com/fbranda/measles/main/USA/data/all/measles-USA-by-mmr-coverage.csv") %>%
  clean_names()
```

```{r us-coverage-plot}
us_plot <- us_coverage %>%
  filter(year >= 2000) %>%
  plot_ly(x = ~year, y = ~coverage_percent, color = ~state,
          type = 'scatter', mode = 'lines') %>%
  layout(title = "US MMR Coverage by State Over Time",
         xaxis = list(title = "Year"),
         yaxis = list(title = "% Coverage"))
us_plot
```

## 2. Measles Case Trends Over Time and Space

```{r load-us-onset}
us_onset <- read_csv("https://raw.githubusercontent.com/fbranda/measles/main/USA/data/all/measles-USA-by-onset-date.csv") %>%
  clean_names()
```

```{r us-onset-timeline}
onset_timeline <- us_onset %>%
  mutate(date_onset = ymd(date_onset)) %>%
  group_by(date_onset) %>%
  summarise(cases = sum(cases, na.rm = TRUE)) %>%
  plot_ly(x = ~date_onset, y = ~cases, type = 'scatter', mode = 'lines') %>%
  layout(title = "US Measles Cases by Onset Date",
         xaxis = list(title = "Date"),
         yaxis = list(title = "Cases"))
onset_timeline
```

## 3. Vaccination vs. Measles Cases Correlation

```{r load-us-state-timeline}
us_state_cases <- read_csv("https://raw.githubusercontent.com/fbranda/measles/main/USA/data/2025/measles-USA-by-state-timeline.csv") %>%
  clean_names()
```

```{r state-summary}
state_summary <- us_coverage %>%
  inner_join(us_state_cases, by = c("state", "year")) %>%
  group_by(state) %>%
  summarise(avg_coverage = mean(coverage_percent, na.rm = TRUE),
            total_cases = sum(cases, na.rm = TRUE))
```

```{r correlation-plot}
correlation_plot <- state_summary %>%
  plot_ly(x = ~avg_coverage, y = ~total_cases, text = ~state,
          type = 'scatter', mode = 'markers') %>%
  layout(title = "MMR Coverage vs. Measles Cases by State",
         xaxis = list(title = "Average % Coverage (2000â€“2025)"),
         yaxis = list(title = "Total Cases (2025)"))
correlation_plot
```

## 4. Age-Specific Risk Analysis

```{r load-age-data}
age_data <- read_csv("https://raw.githubusercontent.com/fbranda/measles/main/USA/data/2025/measles-USA-by-age.csv") %>%
  clean_names()
```

```{r age-risk-bar}
age_bar <- age_data %>%
  plot_ly(x = ~age_group, y = ~cases, type = 'bar') %>%
  layout(title = "Measles Cases by Age Group (2025)",
         xaxis = list(title = "Age Group"),
         yaxis = list(title = "Cases"))
age_bar
```

## 5. Outcome Severity Trends

```{r load-us-year}
us_year <- read_csv("https://raw.githubusercontent.com/fbranda/measles/main/USA/data/all/measles-USA-by-year.csv") %>%
  clean_names()
```

```{r outcomes-over-time}
outcome_plot <- us_year %>%
  plot_ly(x = ~year) %>%
  add_trace(y = ~cases, name = 'Cases', type = 'scatter', mode = 'lines') %>%
  add_trace(y = ~deaths, name = 'Deaths', type = 'scatter', mode = 'lines') %>%
  add_trace(y = ~complications, name = 'Complications', type = 'scatter', mode = 'lines') %>%
  layout(title = "Measles Outcomes in the US Over Time",
         xaxis = list(title = "Year"),
         yaxis = list(title = "Count"))
outcome_plot
```

## Conclusion

This exploratory analysis highlights concerning trends in MMR vaccination and measles resurgence in 2025. Low vaccination coverage correlates strongly with increased outbreak risk. Continued monitoring and policy support are essential to protect public health.
