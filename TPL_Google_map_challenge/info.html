// Get historical context for a year
        function getHistoricalContext(year) {
            const contexts = {
                1883: "Toronto's population was just 96,000 when the first library opened on Church Street. The city was rapidly industrializing and needed public institutions to educate new immigrants and working families.",
                1920: "Post-WWI Toronto was booming with<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toronto Public Library Explorer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #003366 0%, #004080 100%);
            height: 100vh;
            overflow: hidden;
        }
        
        .container {
            display: flex;
            height: 100vh;
            position: relative;
        }
        
        .sidebar {
            width: 350px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 51, 102, 0.3);
            display: flex;
            flex-direction: column;
            z-index: 1000;
        }
        
        .header {
            padding: 20px;
            background: linear-gradient(135deg, #003366, #0066CC);
            color: white;
            text-align: center;
        }
        
        .header h1 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 0.9rem;
        }
        
        .search-section {
            padding: 20px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        
        .search-box {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .search-box:focus {
            outline: none;
            border-color: #0066CC;
            box-shadow: 0 0 15px rgba(0, 102, 204, 0.3);
        }
        
        .filters {
            padding: 20px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        
        .filter-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #003366;
        }
        
        .filter-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .tag {
            padding: 6px 12px;
            background: #ecf0f1;
            border: none;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .tag:hover, .tag.active {
            background: #0066CC;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 102, 204, 0.3);
        }
        
        .recommendations {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .recommendation-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid #0066CC;
        }
        
        .recommendation-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .card-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .library-name {
            font-weight: 600;
            color: #003366;
            font-size: 1rem;
        }
        
        .rating {
            color: #f39c12;
            font-size: 14px;
        }
        
        .library-type {
            color: #7f8c8d;
            font-size: 12px;
            margin-bottom: 5px;
        }
        
        .library-features {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 8px;
        }
        
        .feature-tag {
            background: #E6F3FF;
            color: #003366;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 10px;
        }
        
        .map-container {
            flex: 1;
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .story-overlay {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            max-width: 300px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            z-index: 1000;
            display: none;
        }
        
        .story-title {
            font-weight: 600;
            color: #003366;
            margin-bottom: 10px;
        }
        
        .story-content {
            font-size: 14px;
            line-height: 1.6;
            color: #333333;
        }
        
        .close-story {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #7f8c8d;
        }
        
        .timeline {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 25px;
            padding: 15px 20px;
            display: flex;
            gap: 15px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            z-index: 1000;
        }
        
        .timeline-point {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #ecf0f1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
            font-weight: 600;
            color: #7f8c8d;
        }
        
        .timeline-point:hover, .timeline-point.active {
            background: #0066CC;
            color: white;
            transform: scale(1.1);
        }
        
        .floating-info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            max-width: 250px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            z-index: 1000;
        }
        
        .info-title {
            font-weight: 600;
            color: #003366;
            margin-bottom: 8px;
        }
        
        .info-stats {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 18px;
            z-index: 2000;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .loading {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">Loading Toronto Libraries...</div>
    
    <div class="container" style="display: none;" id="mainContainer">
        <div class="sidebar">
            <div class="header">
                <h1>📚 Toronto Library Explorer</h1>
                <p>Discover your next favorite library</p>
            </div>
            
            <div class="search-section">
                <input type="text" class="search-box" placeholder="🔍 Search libraries across Toronto..." id="searchBox">
            </div>
            
            <div class="filters">
                <div class="filter-title">Library Types</div>
                <div class="filter-tags">
                    <button class="tag active" data-filter="all">All</button>
                    <button class="tag" data-filter="branch">Branch</button>
                    <button class="tag" data-filter="research">Research</button>
                    <button class="tag" data-filter="specialized">Specialized</button>
                    <button class="tag" data-filter="historic">Historic</button>
                </div>
                
                <div class="filter-title">Features</div>
                <div class="filter-tags">
                    <button class="tag" data-filter="wifi">WiFi</button>
                    <button class="tag" data-filter="study">Study Rooms</button>
                    <button class="tag" data-filter="events">Events</button>
                    <button class="tag" data-filter="accessible">Accessible</button>
                </div>
            </div>
            
            <div class="recommendations">
                <div class="filter-title">Smart Recommendations</div>
                <div id="recommendationsList"></div>
            </div>
        </div>
        
        <div class="map-container">
            <div id="map"></div>
            
            <div class="floating-info">
                <div class="info-title">Toronto Public Libraries</div>
                <div class="info-stats">
                    <span>100+ Locations</span>
                    <span>Est. 1883</span>
                </div>
                <div style="margin-top: 10px; font-size: 12px; color: #7f8c8d;">
                    Click on library markers to explore stories, community reviews, and historical significance.
                </div>
            </div>
            
            <div class="story-overlay" id="storyOverlay">
                <button class="close-story" onclick="closeStory()">×</button>
                <div class="story-title" id="storyTitle"></div>
                <div class="story-content" id="storyContent"></div>
            </div>
            
            <div class="timeline">
                <div class="timeline-point active" data-year="1883" title="First Library">1883</div>
                <div class="timeline-point" data-year="1920" title="Carnegie Era">1920</div>
                <div class="timeline-point" data-year="1960" title="Modern Expansion">1960</div>
                <div class="timeline-point" data-year="2000" title="Digital Age">2000</div>
                <div class="timeline-point" data-year="2024" title="Present Day">2024</div>
            </div>
        </div>
    </div>

    <script>
        // Sample library data with enhanced features
        const libraries = [
            {
                id: 1,
                name: "Toronto Reference Library",
                lat: 43.6719,
                lng: -79.3861,
                type: "research",
                rating: 4.8,
                reviews: 2847,
                features: ["wifi", "study", "events", "accessible"],
                description: "The flagship research library at Yonge and Bloor, featuring North America's most comprehensive genealogy collection.",
                story: {
                    title: "The Heart of Toronto's Knowledge District",
                    content: "Built in 1977 at the corner of Yonge and Bloor, this architectural marvel houses over 1.2 million items. Designed by Raymond Moriyama, it's a modernist masterpiece that has become a beloved landmark in Toronto's cultural landscape."
                },
                userReviews: [
                    { user: "Sarah from Rosedale", rating: 5, comment: "Perfect study spot with incredible views of Bloor Street!" },
                    { user: "David from The Annex", rating: 5, comment: "The genealogy section helped me trace my family's Toronto roots back to 1834." }
                ],
                events: ["Digital Literacy Workshop", "Nuit Blanche Preparation", "Toronto History Walking Tours"],
                busyness: "moderate",
                specialties: ["Research", "Genealogy", "Toronto Archives"]
            },
            {
                id: 2,
                name: "Fort York Library",
                lat: 43.6365,
                lng: -79.4038,
                type: "branch",
                rating: 4.6,
                reviews: 1203,
                features: ["wifi", "events", "accessible"],
                description: "Modern library serving downtown Toronto with stunning CN Tower views and War of 1812 historical connections.",
                story: {
                    title: "Where Toronto's Military History Lives",
                    content: "This contemporary library, opened in 2014, sits in the shadow of Fort York and offers spectacular views of the CN Tower. It's perfectly positioned where Toronto's founding military history meets its modern skyline."
                },
                userReviews: [
                    { user: "Maria from Liberty Village", rating: 4, comment: "Amazing CN Tower views and great for working downtown!" },
                    { user: "James from King West", rating: 5, comment: "Love the War of 1812 exhibits and the modern design." }
                ],
                events: ["Doors Open Toronto", "Canada Day Celebrations", "Harbourfront Reading Series"],
                busyness: "busy",
                specialties: ["Military History", "Urban Development", "Architecture"]
            },
            {
                id: 3,
                name: "Beaches Branch Library",
                lat: 43.6677,
                lng: -79.2977,
                type: "branch",
                rating: 4.5,
                reviews: 856,
                features: ["wifi", "study", "accessible"],
                description: "Community library in The Beach, steps from the Toronto Islands ferry and Woodbine Beach.",
                story: {
                    title: "Toronto's Seaside Literary Haven",
                    content: "Located in the heart of The Beach, this library captures the laid-back lakefront spirit. It's been serving the community since 1916, helping residents and visitors alike discover Toronto's unique beachside culture."
                },
                userReviews: [
                    { user: "Lisa from The Beach", rating: 5, comment: "Perfect after a day at Woodbine Beach. Great local history section!" },
                    { user: "Mike from Leslieville", rating: 4, comment: "Love the summer reading programs and proximity to the boardwalk." }
                ],
                events: ["Beaches Jazz Festival Prep", "Toronto Island History Tours", "Lakefront Photography Workshops"],
                busyness: "quiet",
                specialties: ["Beach Culture", "Environmental Studies", "Local Artists"]
            },
            {
                id: 4,
                name: "Robarts Library",
                lat: 43.6634,
                lng: -79.3994,
                type: "research",
                rating: 4.3,
                reviews: 3421,
                features: ["wifi", "study", "accessible"],
                description: "University of Toronto's iconic research library, known as 'Fort Book' - a brutalist landmark on St. George Street.",
                story: {
                    title: "The Fortress of Knowledge on Campus",
                    content: "This brutalist architectural icon, completed in 1973, houses over 4.5 million items. University of Toronto students have nicknamed it 'Fort Book' for its fortress-like appearance. It's a defining feature of Toronto's skyline from the west."
                },
                userReviews: [
                    { user: "Alex from Trinity College", rating: 4, comment: "Massive collection but the building is a maze. Great for serious research on Canadian topics." },
                    { user: "Emma from Victoria College", rating: 5, comment: "The silent study floors are perfect for exam season. Love the Toronto-area thesis collection." }
                ],
                events: ["Doors Open Toronto", "University of Toronto Alumni Events", "Canadian Literature Symposium"],
                busyness: "very_busy",
                specialties: ["Canadian Studies", "Graduate Research", "University Archives"]
            },
            {
                id: 5,
                name: "Lillian H. Smith Branch",
                lat: 43.6532,
                lng: -79.4044,
                type: "specialized",
                rating: 4.9,
                reviews: 674,
                features: ["wifi", "events", "accessible"],
                description: "Specialized children's literature library at College and Spadina, featuring Toronto's most comprehensive youth collections.",
                story: {
                    title: "Where Toronto's Young Readers Begin",
                    content: "Named after Canada's first children's librarian, this magical space houses North America's most comprehensive collection of children's literature. It's been inspiring young Torontonians since 1967 and features special collections from local authors."
                },
                userReviews: [
                    { user: "Jennifer from Kensington Market", rating: 5, comment: "My kids love the Toronto-themed story times! Amazing collection of Canadian children's books." },
                    { user: "Robert from Chinatown", rating: 5, comment: "Incredible collection including early Toronto children's authors. A true research treasure." }
                ],
                events: ["Winterlicious Storytime", "Toronto Children's Book Festival", "Young Authors Workshop"],
                busyness: "moderate",
                specialties: ["Children's Literature", "Canadian Authors", "Youth Programs"]
            },
            {
                id: 6,
                name: "North York Central Library",
                lat: 43.7615,
                lng: -79.4111,
                type: "branch",
                rating: 4.7,
                reviews: 1987,
                features: ["wifi", "study", "events", "accessible"],
                description: "Modern library at Yonge and Sheppard serving North York's diverse communities with extensive multilingual collections.",
                story: {
                    title: "North York's Cultural Heart",
                    content: "This contemporary library, opened in 1987, represents Toronto's commitment to serving diverse communities. Located at the bustling Yonge-Sheppard intersection, it features extensive multilingual collections reflecting Toronto's multicultural identity."
                },
                userReviews: [
                    { user: "Priya from Willowdale", rating: 5, comment: "Excellent Tamil and Hindi collections! Perfect for North York families." },
                    { user: "Carlos from Thornhill", rating: 4, comment: "Great study spaces and easy TTC access. Love the multicultural programming." }
                ],
                events: ["Caribana Information Sessions", "Taste of the Danforth Prep", "Multicultural Heritage Month"],
                busyness: "busy",
                specialties: ["Multicultural Services", "TTC Access", "Community Programs"]
            }
        ];

        // Historical timeline data
        const timelineData = {
            1883: {
                title: "Toronto's Literary Dawn",
                content: "Toronto's first public library opens its doors on Church Street, establishing free public access to knowledge for all Torontonians during the city's rapid industrial growth.",
                libraries: ["Original Toronto Public Library"]
            },
            1920: {
                title: "Carnegie Era in Hogtown",
                content: "With Carnegie Foundation funding, Toronto builds multiple libraries across growing neighbourhoods like The Annex, Riverdale, and High Park, bringing literacy to every corner of the expanding city.",
                libraries: ["High Park Library", "Riverdale Branch", "Queen-Saulter Library"]
            },
            1960: {
                title: "Metro Toronto's Modern Vision",
                content: "As Metro Toronto forms and suburbs expand, new libraries embrace modernist design in Scarborough, North York, and Etobicoke, serving the growing 416 with innovative community-centered spaces.",
                libraries: ["Agincourt Branch", "Albion Mall Library", "Scarborough Civic Centre"]
            },
            2000: {
                title: "T-Dot Goes Digital",
                content: "The megacity era brings digital transformation to all Toronto libraries. From Etobicoke to Scarborough, every branch offers internet access, bridging the digital divide across the entire 416 and 905.",
                libraries: ["All 100+ TPL Branches"]
            },
            2024: {
                title: "The 6ix's Innovation Hubs",
                content: "Today's Toronto libraries serve as innovation spaces from Parkdale to The Beaches, offering maker labs, Indigenous programming, and multilingual services that reflect our city's incredible diversity.",
                libraries: ["100+ Modern Community Hubs"]
            }
        };

        let map;
        let markers = [];
        let currentFilter = 'all';
        let infoWindow;

        // Initialize the application
        function initApp() {
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('mainContainer').style.display = 'flex';
                initMap();
                setupEventListeners();
                generateRecommendations();
            }, 1500);
        }

        // Initialize Google Maps (simulation)
        function initMap() {
            // Since we can't use actual Google Maps API, we'll create a styled map simulation
            const mapElement = document.getElementById('map');
            mapElement.style.background = `
                radial-gradient(circle at 30% 20%, rgba(0, 102, 204, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 70% 70%, rgba(0, 51, 102, 0.2) 0%, transparent 50%),
                linear-gradient(135deg, #0066CC 0%, #003366 100%)
            `;
            mapElement.innerHTML = `
                <div style="position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: white; font-size: 18px; text-align: center;">
                    <div>
                        <div style="margin-bottom: 20px;">🗺️ Interactive Toronto Library Map</div>
                        <div style="font-size: 14px; opacity: 0.8;">Click library pins to explore stories and community reviews</div>
                    </div>
                </div>
            `;

            // Add library markers (simulated)
            addLibraryMarkers();
        }

        // Add library markers to map
        function addLibraryMarkers() {
            const mapContainer = document.getElementById('map');
            
            libraries.forEach(library => {
                const marker = document.createElement('div');
                marker.className = 'library-marker';
                marker.style.cssText = `
                    position: absolute;
                    width: 40px;
                    height: 40px;
                    background: ${getMarkerColor(library.type)};
                    border: 3px solid white;
                    border-radius: 50%;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 18px;
                    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                    transition: all 0.3s ease;
                    left: ${50 + (library.id - 3) * 15}%;
                    top: ${40 + (library.id - 3) * 10}%;
                    z-index: 100;
                `;
                
                marker.innerHTML = getMarkerIcon(library.type);
                marker.title = library.name;
                
                marker.addEventListener('mouseenter', () => {
                    marker.style.transform = 'scale(1.2)';
                    marker.style.zIndex = '200';
                });
                
                marker.addEventListener('mouseleave', () => {
                    marker.style.transform = 'scale(1)';
                    marker.style.zIndex = '100';
                });
                
                marker.addEventListener('click', () => {
                    showLibraryStory(library);
                    highlightLibraryInSidebar(library.id);
                });
                
                mapContainer.appendChild(marker);
                markers.push({ element: marker, library: library });
            });
        }

        // Get marker color based on library type
        function getMarkerColor(type) {
            const colors = {
                'research': '#CC0000',      // Toronto red
                'branch': '#0066CC',        // TPL blue
                'specialized': '#003366',   // Dark blue
                'historic': '#FF6600'       // Orange accent
            };
            return colors[type] || '#0066CC';
        }

        // Get marker icon based on library type
        function getMarkerIcon(type) {
            const icons = {
                'research': '🔬',
                'branch': '📚',
                'specialized': '⭐',
                'historic': '🏛️'
            };
            return icons[type] || '📚';
        }

        // Show library story overlay
        function showLibraryStory(library) {
            const overlay = document.getElementById('storyOverlay');
            const title = document.getElementById('storyTitle');
            const content = document.getElementById('storyContent');
            
            title.textContent = library.story.title;
            content.innerHTML = `
                <p style="margin-bottom: 15px;">${library.story.content}</p>
                <div style="border-top: 1px solid #eee; padding-top: 15px; margin-top: 15px;">
                    <h4 style="margin-bottom: 10px; color: #2c3e50;">Community Reviews</h4>
                    ${library.userReviews.map(review => `
                        <div style="margin-bottom: 10px; padding: 8px; background: #f8f9fa; border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <strong style="font-size: 12px;">${review.user}</strong>
                                <span style="color: #f39c12; font-size: 12px;">${'★'.repeat(review.rating)}</span>
                            </div>
                            <p style="font-size: 12px; color: #7f8c8d;">${review.comment}</p>
                        </div>
                    `).join('')}
                </div>
                <div style="border-top: 1px solid #eee; padding-top: 15px; margin-top: 15px;">
                    <h4 style="margin-bottom: 10px; color: #2c3e50;">Current Events</h4>
                    ${library.events.map(event => `
                        <div style="margin-bottom: 5px; padding: 5px 10px; background: #e8f4fd; border-radius: 15px; font-size: 11px; display: inline-block; margin-right: 5px;">${event}</div>
                    `).join('')}
                </div>
            `;
            
            overlay.style.display = 'block';
        }

        // Close story overlay
        function closeStory() {
            document.getElementById('storyOverlay').style.display = 'none';
        }

        // Generate smart recommendations
        function generateRecommendations() {
            const container = document.getElementById('recommendationsList');
            
            // Simulate ML-based recommendations
            const recommendations = [
                {
                    library: libraries[0],
                    reason: "Perfect for your research interests",
                    confidence: 95
                },
                {
                    library: libraries[4],
                    reason: "Great for family visits",
                    confidence: 87
                },
                {
                    library: libraries[2],
                    reason: "Quiet study environment nearby",
                    confidence: 82
                },
                {
                    library: libraries[5],
                    reason: "Matches your community preferences",
                    confidence: 78
                }
            ];
            
            container.innerHTML = recommendations.map(rec => `
                <div class="recommendation-card" onclick="focusLibrary(${rec.library.id})">
                    <div class="card-header">
                        <div class="library-name">${rec.library.name}</div>
                        <div class="rating">★ ${rec.library.rating}</div>
                    </div>
                    <div class="library-type">${rec.library.type.charAt(0).toUpperCase() + rec.library.type.slice(1)} Library</div>
                    <div style="font-size: 12px; color: #27ae60; margin-bottom: 8px;">
                        ${rec.confidence}% match • ${rec.reason}
                    </div>
                    <div style="font-size: 12px; color: #7f8c8d; margin-bottom: 8px;">
                        ${rec.library.description}
                    </div>
                    <div class="library-features">
                        ${rec.library.features.map(feature => `
                            <span class="feature-tag">${feature}</span>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        // Focus on specific library
        function focusLibrary(libraryId) {
            const library = libraries.find(lib => lib.id === libraryId);
            if (library) {
                showLibraryStory(library);
                highlightLibraryInSidebar(libraryId);
            }
        }

        // Highlight library in sidebar
        function highlightLibraryInSidebar(libraryId) {
            // Remove previous highlights
            document.querySelectorAll('.recommendation-card').forEach(card => {
                card.style.borderLeft = '4px solid #3498db';
            });
            
            // Add highlight to selected library (simplified implementation)
            const cards = document.querySelectorAll('.recommendation-card');
            const library = libraries.find(lib => lib.id === libraryId);
            if (library) {
                cards.forEach(card => {
                    if (card.textContent.includes(library.name)) {
                        card.style.borderLeft = '4px solid #e74c3c';
                        card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                });
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Filter buttons
            document.querySelectorAll('.tag').forEach(tag => {
                tag.addEventListener('click', function() {
                    // Update active state
                    document.querySelectorAll('.tag').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Apply filter
                    const filter = this.dataset.filter;
                    applyFilter(filter);
                });
            });

            // Timeline points
            document.querySelectorAll('.timeline-point').forEach(point => {
                point.addEventListener('click', function() {
                    // Update active state
                    document.querySelectorAll('.timeline-point').forEach(p => p.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Show historical information
                    const year = this.dataset.year;
                    showHistoricalInfo(year);
                });
            });

            // Search functionality
            document.getElementById('searchBox').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                filterLibrariesBySearch(searchTerm);
            });
        }

        // Apply filter to libraries
        function applyFilter(filter) {
            currentFilter = filter;
            
            markers.forEach(marker => {
                const library = marker.library;
                let show = true;
                
                if (filter !== 'all') {
                    if (library.type !== filter && !library.features.includes(filter)) {
                        show = false;
                    }
                }
                
                marker.element.style.display = show ? 'flex' : 'none';
                
                // Add filter animation
                if (show) {
                    marker.element.style.animation = 'fadeIn 0.5s ease-in';
                }
            });
            
            // Update recommendations based on filter
            updateRecommendations(filter);
        }

        // Filter libraries by search term
        function filterLibrariesBySearch(searchTerm) {
            markers.forEach(marker => {
                const library = marker.library;
                const searchableText = [
                    library.name,
                    library.description,
                    library.type,
                    ...library.features,
                    ...library.events,
                    ...library.specialties
                ].join(' ').toLowerCase();
                
                const show = searchableText.includes(searchTerm);
                marker.element.style.display = show ? 'flex' : 'none';
            });
            
            // Update recommendations list based on search
            if (searchTerm) {
                updateSearchRecommendations(searchTerm);
            } else {
                generateRecommendations();
            }
        }

        // Update recommendations based on filter
        function updateRecommendations(filter) {
            const container = document.getElementById('recommendationsList');
            let filteredLibraries = libraries;
            
            if (filter !== 'all') {
                filteredLibraries = libraries.filter(lib => 
                    lib.type === filter || lib.features.includes(filter)
                );
            }
            
            const recommendations = filteredLibraries.map(library => ({
                library: library,
                reason: getFilterReason(filter, library),
                confidence: Math.floor(Math.random() * 20) + 80
            }));
            
            container.innerHTML = recommendations.map(rec => `
                <div class="recommendation-card" onclick="focusLibrary(${rec.library.id})">
                    <div class="card-header">
                        <div class="library-name">${rec.library.name}</div>
                        <div class="rating">★ ${rec.library.rating}</div>
                    </div>
                    <div class="library-type">${rec.library.type.charAt(0).toUpperCase() + rec.library.type.slice(1)} Library</div>
                    <div style="font-size: 12px; color: #27ae60; margin-bottom: 8px;">
                        ${rec.confidence}% match • ${rec.reason}
                    </div>
                    <div style="font-size: 12px; color: #7f8c8d; margin-bottom: 8px;">
                        ${rec.library.description}
                    </div>
                    <div class="library-features">
                        ${rec.library.features.map(feature => `
                            <span class="feature-tag">${feature}</span>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        // Get reason for filter recommendation
        function getFilterReason(filter, library) {
            const reasons = {
                'all': 'Highly rated in your area',
                'branch': 'Great community hub',
                'research': 'Perfect for deep research',
                'specialized': 'Unique collections and services',
                'historic': 'Rich cultural heritage',
                'wifi': 'Excellent connectivity',
                'study': 'Quiet study environment',
                'events': 'Active community programming',
                'accessible': 'Fully accessible facilities'
            };
            return reasons[filter] || reasons['all'];
        }

        // Update recommendations based on search
        function updateSearchRecommendations(searchTerm) {
            const container = document.getElementById('recommendationsList');
            
            const matchingLibraries = libraries.filter(library => {
                const searchableText = [
                    library.name,
                    library.description,
                    library.type,
                    ...library.features,
                    ...library.events,
                    ...library.specialties
                ].join(' ').toLowerCase();
                
                return searchableText.includes(searchTerm.toLowerCase());
            });
            
            if (matchingLibraries.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #7f8c8d;">
                        <div style="font-size: 48px; margin-bottom: 10px;">🔍</div>
                        <div>No libraries found matching "${searchTerm}"</div>
                        <div style="font-size: 12px; margin-top: 10px;">Try searching for: wifi, events, study, research</div>
                    </div>
                `;
                return;
            }
            
            const recommendations = matchingLibraries.map(library => ({
                library: library,
                reason: `Matches your search for "${searchTerm}"`,
                confidence: Math.floor(Math.random() * 15) + 85
            }));
            
            container.innerHTML = recommendations.map(rec => `
                <div class="recommendation-card" onclick="focusLibrary(${rec.library.id})">
                    <div class="card-header">
                        <div class="library-name">${rec.library.name}</div>
                        <div class="rating">★ ${rec.library.rating}</div>
                    </div>
                    <div class="library-type">${rec.library.type.charAt(0).toUpperCase() + rec.library.type.slice(1)} Library</div>
                    <div style="font-size: 12px; color: #27ae60; margin-bottom: 8px;">
                        ${rec.confidence}% match • ${rec.reason}
                    </div>
                    <div style="font-size: 12px; color: #7f8c8d; margin-bottom: 8px;">
                        ${rec.library.description}
                    </div>
                    <div class="library-features">
                        ${rec.library.features.map(feature => `
                            <span class="feature-tag">${feature}</span>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        // Show historical information
        function showHistoricalInfo(year) {
            const data = timelineData[year];
            const overlay = document.getElementById('storyOverlay');
            const title = document.getElementById('storyTitle');
            const content = document.getElementById('storyContent');
            
            title.textContent = `${year}: ${data.title}`;
            content.innerHTML = `
                <p style="margin-bottom: 15px;">${data.content}</p>
                <div style="border-top: 1px solid #eee; padding-top: 15px; margin-top: 15px;">
                    <h4 style="margin-bottom: 10px; color: #2c3e50;">Libraries Featured</h4>
                    ${data.libraries.map(lib => `
                        <div style="margin-bottom: 5px; padding: 5px 10px; background: #f8f9fa; border-radius: 15px; font-size: 12px; display: inline-block; margin-right: 5px;">${lib}</div>
                    `).join('')}
                </div>
                <div style="border-top: 1px solid #eee; padding-top: 15px; margin-top: 15px;">
                    <h4 style="margin-bottom: 10px; color: #2c3e50;">Historical Context</h4>
                    <p style="font-size: 12px; color: #7f8c8d; line-height: 1.6;">
                        ${getHistoricalContext(year)}
                    </p>
                </div>
            `;
            
            overlay.style.display = 'block';
            
            // Highlight libraries from this era on the map
            highlightHistoricalLibraries(year);
        }

        // Get historical context for a year
        function getHistoricalContext(year) {
            const contexts = {
                1883: "Toronto's population was just 96,000 when the first library opened, marking the city's commitment to public education and literacy during the Industrial Revolution.",
                1920: "Post-WWI Toronto experienced massive growth. Carnegie libraries democratized knowledge access, helping integrate waves of new immigrants into Canadian society.",
                1960: "The suburban boom required new library models. Modern architecture reflected optimism about technology's role in education and community building.",
                2000: "The internet age forced libraries to reinvent themselves. Toronto led in providing digital equity, ensuring all residents could access the information superhighway.",
                2024: "Libraries now serve as innovation hubs, offering everything from 3D printing to startup incubators, proving their continued relevance in the digital age."
            };
            return contexts[year] || "A significant period in Toronto's library development.";
        }

        // Highlight libraries from historical era
        function highlightHistoricalLibraries(year) {
            markers.forEach(marker => {
                const library = marker.library;
                
                // Reset all markers
                marker.element.style.border = '3px solid white';
                marker.element.style.boxShadow = '0 4px 15px rgba(0,0,0,0.3)';
                
                // Highlight relevant libraries based on year
                let shouldHighlight = false;
                
                switch(year) {
                    case '1883':
                        shouldHighlight = library.name.includes('Central');
                        break;
                    case '1920':
                        shouldHighlight = library.type === 'historic' || library.name.includes('Central');
                        break;
                    case '1960':
                        shouldHighlight = library.name.includes('North York') || library.type === 'branch';
                        break;
                    case '2000':
                        shouldHighlight = library.features.includes('wifi') || library.type === 'research';
                        break;
                    case '2024':
                        shouldHighlight = true; // All current libraries
                        break;
                }
                
                if (shouldHighlight) {
                    marker.element.style.border = '3px solid #f39c12';
                    marker.element.style.boxShadow = '0 4px 20px rgba(243, 156, 18, 0.6)';
                    marker.element.style.animation = 'pulse 2s infinite';
                }
            });
        }

        // Add CSS animation for fadeIn and pulse
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeIn {
                from { opacity: 0; transform: scale(0.8); }
                to { opacity: 1; transform: scale(1); }
            }
            
            @keyframes pulse {
                0%, 100% { transform: scale(1); }
                50% { transform: scale(1.1); }
            }
            
            .library-marker {
                transition: all 0.3s ease;
            }
            
            .library-marker:hover {
                transform: scale(1.2) !important;
                z-index: 200 !important;
            }
        `;
        document.head.appendChild(style);

        // Initialize the application when the page loads
        window.addEventListener('load', initApp);

        // Add some interactive demo features
        function addInteractiveFeatures() {
            // Simulate real-time updates
            setInterval(() => {
                // Update library busyness levels
                libraries.forEach(library => {
                    const busynessLevels = ['quiet', 'moderate', 'busy', 'very_busy'];
                    library.busyness = busynessLevels[Math.floor(Math.random() * busynessLevels.length)];
                });
                
                // Update floating info with current stats
                const infoStats = document.querySelector('.info-stats');
                if (infoStats) {
                    const totalVisitors = Math.floor(Math.random() * 5000) + 15000;
                    const activeEvents = Math.floor(Math.random() * 20) + 25;
                    infoStats.innerHTML = `
                        <span>${totalVisitors.toLocaleString()} Monthly Visitors</span>
                        <span>${activeEvents} Active Events</span>
                    `;
                }
            }, 10000); // Update every 10 seconds
        }

        // Start interactive features
        setTimeout(addInteractiveFeatures, 2000);
    </script>
</body>
</html>